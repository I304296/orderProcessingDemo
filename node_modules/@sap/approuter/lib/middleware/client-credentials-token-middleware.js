'use strict';
var tokenUtils = require('../utils/token-utils');
var xsenv = require('@sap/xsenv');

module.exports = function renewToken(req, res, next) {
  if (req.internalUrl && req.internalUrl.route && req.internalUrl.route.service) {
    var serviceName = req.internalUrl.route.service;
    if (req && req.app && req.app.services && req.app.services[serviceName]){
      var service = req.app.services[serviceName];
      if (service.token && service.token.tokenRefreshTimestamp - Date.now() <= 0){
        var serviceFromEnv = getServiceByName(serviceName);
        return tokenUtils.loadClientCredentialsToken(req.app, serviceFromEnv.credentials, service, function(err){
          return next(err);
        });
      }
    }
  }
  next();
};

function getServiceByName(serviceName){
  var services = xsenv.readServices();
  return services[serviceName];
}