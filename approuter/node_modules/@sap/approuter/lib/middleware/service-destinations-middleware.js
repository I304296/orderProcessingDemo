'use strict';

var bsUtils       = require('../utils/business-service-utils');
var urlUtils      = require('../utils/url-utils');
var uaaUtils      = require('../utils/uaa-utils');
var configUtils   = require('../utils/configuration-utils');
var drUtils       = require('../utils/dynamic-routing-utils');
var cookie        = require('cookie');

module.exports = function cacheServiceDestination(req, res, next) {
  if (!process.env.SAAS_APPROUTER){
    return next();
  }
  var requestHost = urlUtils.getAppRouterHost(req);
  if (!process.env.TENANT_HOST_PATTERN){
    return next('Tenant host pattern is not defined');
  }
  var tenantHostPattern = configUtils.constructRegExp(process.env.TENANT_HOST_PATTERN);
  if (!tenantHostPattern){
    return next('Failed to extract tenant host pattern');
  }
  req.tenant = uaaUtils.retrieveTenantFromURL(requestHost, tenantHostPattern);
  bsUtils.cacheBSDestinations(req, function(err){
    if (err) {
      return next(err);
    }
    var cookies     = req.headers['cookie'] ? cookie.parse(req.headers['cookie']) : null;
    var source      = cookies && cookies.locationAfterLogin ? {url: cookies.locationAfterLogin} : req;
    var appKey      = drUtils.getApplicationKey(source);
    if (appKey && appKey.appPrefix) {
      var credentials = bsUtils.getCredentials(appKey.appPrefix, true, req);
      if (credentials && credentials.uaa) {
        req.destinationCredentials = credentials;
      }
    }
    next();
  });
};